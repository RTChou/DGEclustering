---
title: "DGE_downstream"
author: "Renee Ti Chou"
date: "August 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

#### Note 1: installing DGEclustering package
```{r}
setwd('~/Downloads/dictyostelium_2')
install.packages('DGEclustering', type='source', repos=NULL)
```


## 1. Import libraries and AnnotationHub
```{r}
library(DGEclustering)
library(AnnotationHub)
library(RSQLite)
library(stringr)
library(ggplot2)
library(clusterProfiler)
hub <- AnnotationHub::.Hub("AnnotationHub",
        getAnnotationHubOption("URL"),

        # Cache location is specific to this instance of lcdb-wf so we don't
        # clobber old runs with new annotation data
        './AnnotationHubCache',

        httr::use_proxy(Sys.getenv("http_proxy")),
        FALSE)
```


## 2. Set the working directory, and specify the column name for gene IDs, 
organism database, and key type
```{r}
gene.col <- 'gene'
orgdb <- query(hub, 'Drosophila melanogaster')[['AH57972']]
keytype <- 'FLYBASE'
```


## 3. Set the (adjusted) p-value thresholds
```{r}
x.threshold <- 0.05
y.threshold <- 0.05
adjPvalue <- TRUE
```


## 4. Automation of diagnostic plots
```{r}
automation(rootDir='./', geneCol=gene.col, x.threshold=x.threshold, y.threshold=y.threshold, adjPvalue=adjPvalue, qqPlot=FALSE, fishPlot=FALSE, scatterPlot=TRUE)

# (optional) search for files in the database
mydb <- dbConnect(RSQLite::SQLite(), 'rnaseq.db')
dbListTables(mydb)
# remember to close and disconnect the database
dbDisconnect(mydb)
unlink('rnaseq.db')
```


## 5. Specify the paths of input files
```{r}
data(list=c('treatment1.vs.control', 'treatment2.vs.control', 'treatment3.vs.control'))
datasets <- list(treatment1.vs.control, treatment2.vs.control)
names(datasets) <- c('treatment1.vs.control', 'treatment2.vs.control')


datasets <- list(treatment1.vs.control, treatment2.vs.control, treatment3.vs.control)

plotting.dir <- './padj_multiple_0.9'
system(paste('mkdir', plotting.dir)) # to make a new plotting directory
```

```{r}
# generate sig plot and subsets
sig.res <- sig.subset(datasets, geneCol=gene.col, x.dsNumber=1, y.dsNumber=2, x.threshold=x.threshold, y.threshold=y.threshold, adjPvalue=adjPvalue)
```

## 6. Annotate Genes
```{r}
## sig plot
sig.res$p
## For two paired datasets
if (length(sig.res) == 3) {
  dat <- rbind(sig.res$dis, sig.res$con)
} else { ## For time course data
  dat <- sig.res$dat
}
bg.genes <- treatment1.vs.control[gene.col]
ann <- annotate.genes(OrgDb=orgdb, keyType=keytype, genes=unlist(dat[gene.col]), GOEnrichment=FALSE, BgGenes=bg.genes)
```


## 7. Prepare expression and annotation datasets for clustering
expressions: choose the desired dimensions <br> 
annotations: choose the number of GO terms for optimal clustering <br> 
number of group: choose the number of group for optimal clustering <br> 

```{r}
# expressions
exp <- scale(dat[,grepl("log2FoldChange|padj", colnames(dat))])
rownames(exp) <- make.names(dat[,gene.col], unique=TRUE)

#annotaitons
## less than 30
sum(apply(ann, 2, sum) >= 5)
ann <- ann[, apply(ann, 2, sum) >= 100]

# number of groups
nb.group=8

# generate log file
log.info <- data.frame(item=c('dimensions', ''))
```


## 8. Cluster genes, export the result, and visualize the clustering result
```{r}
res <- DGE.clust(expressions=exp, annotations=ann, clust.method='intego', nb.group=nb.group)

# view clustering result
res$groups # code to view the clustering result

# visualize the clustering result
test <- cluster.plot(datasets, res$groups, x.dsNumber=1, y.dsNumber=2, geneCol=gene.col, adjPvalue=adjPvalue, color='brg')

cluster.plot(res.groups=res$groups, res.MCA=res$MCA, MCA=TRUE, geneCol=gene.col, adjPvalue=adjPvalue, color='brg')
```


## 9. GO enrichment of the clustering result (plotting)
```{r}
bg.genes <- read.table(file1, header=TRUE, sep='\t', stringsAsFactors=TRUE)[gene.col]

cluster.enrich(clusterGroups=res$groups, OrgDb=orgdb, keyType=keytype, BgGenes=bg.genes, ont='CC', top=10)

plot.path <- 'intego_0.01_2_CC.png'
ggsave(paste(plotting.dir, plot.path, sep='/')) # to save the plot
```

