---
title: "DGE_downstream"
author: "Renee Ti Chou"
date: "August 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

## Import libraries and set working directory
```{r}
library(DGEclustering)
library(AnnotationHub)
library(RSQLite)
setwd('~/Downloads/dictyostelium_2/test')
```

## Automation
```{r}
automation(rootDir='./', geneCol='GENEID', x.threshold=0.05, y.threshold=0.05, adjPvalue=TRUE, qqPlot=FALSE, fishPlot=FALSE, scatterPlot=TRUE)
```

## Download organism database
```{r}
hub <- AnnotationHub::.Hub("AnnotationHub",
        getAnnotationHubOption("URL"),

        # Cache location is specific to this instance of lcdb-wf so we don't
        # clobber old runs with new annotation data
        './AnnotationHubCache',

        httr::use_proxy(Sys.getenv("http_proxy")),
        FALSE)

org.db <- query(hub, 'Dictyostelium discoideum_AX4')[[1]]
key.type <- 'SYMBOL'
```

## Search for files in database
```{r}
mydb <- dbConnect(RSQLite::SQLite(), 'rnaseq.db')
dbListTables(mydb)
```

## Close and disconnect the database
```{r}
dbDisconnect(mydb)
unlink('rnaseq.db')
```

## Import paired dataset(s)
```{r}
dis<- 'paired_files/rapamycin.GDT.t30.vs.control.GDT.t30_vs_control.GDT.t30.vs.control.GDT.t0_disagreeing_genes.tsv'
con <- 'paired_files/rapamycin.GDT.t30.vs.control.GDT.t30_vs_control.GDT.t30.vs.control.GDT.t0_agreeing_genes.tsv'

dis.dat <- read.table(dis, header=TRUE, sep='\t')
con.dat <- read.table(con, header=TRUE, sep='\t')
paired.dat <- rbind(dis.dat, con.dat)
```

## Import all genes
```{r}
gene.col <- 'GENEID'
all <- 'rapamycin.GDT.t30.vs.control.GDT.t30.tsv'
bg.genes <- read.table(all, header=TRUE, sep='\t')[gene.col]
```

## Annotate Genes
```{r}
dat <- annotate.genes(OrgDb=org.db, keyType=key.type, pairedDataset=paired.dat, geneCol=gene.col, GOEnrichment=FALSE, BgGenes=bg.genes)
```

## Prepare expression and annotation datasets for clustering
expressions: choose the desired dimensions 
annotations: choose the number of GO terms for optimal clustering
number of group: choose the number of group for optimal clustering

```{r}
exp <- scale(dat[, c(2, 6, 8, 12)])
rownames(exp) <- dat[, paste(gene.col, 'x', sep='_')]

ann <- dat[, c(14:ncol(dat)), drop=FALSE]
sum(apply(ann, 2, sum) >= 2)
ann <- ann[, apply(ann, 2, sum) >= 2]
rownames(ann) <- dat[, paste(gene.col, 'x', sep='_')]

nb.group=8
```

## Cluster genes and export the result
```{r}
res <- DGE.clust(expressions=exp, annotations=ann, clust.method='intego', nb.group=nb.group)

out.path <- 'intego_result.tsv'
write.table(stack(res$groups), out.path, sep='\t', row.names=FALSE)
```

## Visualize the clustering result
```{r}
file1 <- 'rapamycin.GDT.t30.vs.control.GDT.t30.tsv'
file2 <- 'control.GDT.t30.vs.control.GDT.t0.tsv'
cluster.filepath <- 'intego_result.tsv'
out.dir <- './rapamycin_control_1'

cluster.plot(outDir=out.dir, filePath1=file1, filePath2=file2, clusterFilePath=cluster.filepath, geneCol=gene.col, x.threshold=0.05, y.threshold=0.05, adjPvalue=TRUE, sigData='ALL', color='brg')
```

## GO enrichment of the clustering result (plotting)
```{r}
bg.genes <- 'filepath'['GENEID']
cluster.enrich(clusterGroups=res$groups, OrgDb=org.db, keyType=key.type, BgGenes=bg.genes, ont='BP', top=10)
```

