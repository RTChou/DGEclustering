---
title: "DGE_downstream"
author: "Renee Ti Chou"
date: "August 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
```

#### Note 1: installing DGEclustering package
```{r}
setwd('~/Downloads')
install.packages('DGEclustering', type='source', repos=NULL)
```


## 1. Import libraries and AnnotationHub
```{r}
library(DGEclustering)
library(AnnotationHub)
library(RSQLite)
library(stringr)
hub <- AnnotationHub::.Hub("AnnotationHub",
        getAnnotationHubOption("URL"),

        # Cache location is specific to this instance of lcdb-wf so we don't
        # clobber old runs with new annotation data
        './AnnotationHubCache',

        httr::use_proxy(Sys.getenv("http_proxy")),
        FALSE)
```

## 2. Set the working directory, and specify the column name for gene IDs, 
organism database, and key type
```{r}
setwd('~/Downloads/dictyostelium_2/test')
gene.col <- 'GENEID'
org.db <- query(hub, 'Dictyostelium discoideum_AX4')[[1]]
key.type <- 'SYMBOL'
```

## 3. Set the (adjusted) p-value thresholds
```{r}
x.threshold <- 0.01
y.threshold <- 0.01
adjPvalue <- TRUE
```


## 4. Automation of diagnostic plots
```{r}
# generate scatter plots and corresponding files for significant genes
automation(rootDir='./', geneCol=gene.col, x.threshold=x.threshold, y.threshold=y.threshold, adjPvalue=adjPvalue, qqPlot=FALSE, fishPlot=FALSE, scatterPlot=TRUE)
```


## (Opt.) Search for files in database
```{r}
mydb <- dbConnect(RSQLite::SQLite(), 'rnaseq.db')
dbListTables(mydb)

# many other SQLite functions...
```


## (Opt.) Remember to close and disconnect the database
```{r}
dbDisconnect(mydb)
unlink('rnaseq.db')
```


## 5. Specify the paths of input files
```{r}
# the order of x.file and y.file matters
x.file <- 'control.GDT.t2h.vs.control.GDT.t30.tsv'
y.file <- 'control.GDT.t30.vs.control.GDT.t0.tsv'
cluster.out <- 'intego_result_time_series_1.tsv'
plotting.out <- './qvalue_0.01_1'
system(paste('mkdir', plotting.out)) # to make new plotting directory
```


## 6. Annotate Genes
```{r}
dir <- 'paired_files' 
dis.file <- paste(str_match(x.file, '(.+).tsv')[,2], 'vs', str_match(y.file, '(.+).tsv')[,2], 'disagreeing_genes.tsv', sep='_')
con.file <- paste(str_match(x.file, '(.+).tsv')[,2], 'vs', str_match(y.file, '(.+).tsv')[,2], 'agreeing_genes.tsv', sep='_')
dis.dat <- read.table(paste(dir, dis.file, sep='/'), header=TRUE, sep='\t')
con.dat <- read.table(paste(dir, con.file, sep='/'), header=TRUE, sep='\t')
paired.dat <- rbind(dis.dat, con.dat)
bg.genes <- read.table(x.file, header=TRUE, sep='\t')[gene.col]

dat <- annotate.genes(OrgDb=org.db, keyType=key.type, pairedDataset=paired.dat, geneCol=gene.col, GOEnrichment=FALSE, BgGenes=bg.genes)
```


## 7. Prepare expression and annotation datasets for clustering
expressions: choose the desired dimensions <br> 
annotations: choose the number of GO terms for optimal clustering <br> 
number of group: choose the number of group for optimal clustering <br> 

```{r}
# expressions
exp <- scale(dat[, c(2, 6, 8, 12)])
rownames(exp) <- dat[, paste(gene.col, 'x', sep='_')]

#annotaitons
ann <- dat[, c(14:ncol(dat)), drop=FALSE]
sum(apply(ann, 2, sum) >= 3)
ann <- ann[, apply(ann, 2, sum) >= 3]
rownames(ann) <- dat[, paste(gene.col, 'x', sep='_')]

# number of groups
nb.group=8
```


## 8. Cluster genes, export the result, and visualize the clustering result
```{r}
res <- DGE.clust(expressions=exp, annotations=ann, clust.method='intego', nb.group=nb.group)

# res$groups # code to view the clustering result
write.table(stack(res$groups), cluster.out, sep='\t', row.names=FALSE)

# visualize the clustering result
cluster.plot(outDir=plotting.out, filePath1=x.file, filePath2=y.file, clusterFilePath=cluster.out, geneCol=gene.col, x.threshold=x.threshold, y.threshold=y.threshold, adjPvalue=adjPvalue, sigData='ALL', color='brg')
```


## 9. GO enrichment of the clustering result (plotting)
```{r}
bg.genes <- read.table(x.file, header=TRUE, sep='\t')[gene.col]

cluster.enrich(clusterGroups=res$groups, OrgDb=org.db, keyType=key.type, BgGenes=bg.genes, ont='BP', top=10)
```

